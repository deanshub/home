- name: Get active network interface
  shell: ip route | grep default | awk '{print $5}' | head -1
  register: network_interface

- name: Get current gateway
  shell: ip route | grep default | awk '{print $3}' | head -1
  register: current_gateway

- name: Set fallback gateway
  set_fact:
    gateway_ip: "{{ current_gateway.stdout if current_gateway.stdout else (static_ip | regex_replace('\\.[0-9]+$', '.1')) }}"

- name: Remove existing netplan files
  shell: rm -f /etc/netplan/*.yaml /etc/netplan/*.yml

- name: Configure static IP with netplan
  copy:
    dest: /etc/netplan/01-netcfg.yml
    content: |
      network:
        version: 2
        ethernets:
          {{ network_interface.stdout }}:
            dhcp4: no
            addresses: [{{ static_ip }}/24]
            gateway4: {{ gateway_ip }}
            nameservers:
              addresses: [8.8.8.8,8.8.4.4]

- name: Apply netplan
  command: netplan apply

- name: Ensure DNS is configured correctly
  copy:
    dest: /etc/resolv.conf
    content: |
      nameserver 8.8.8.8
      nameserver 8.8.4.4
